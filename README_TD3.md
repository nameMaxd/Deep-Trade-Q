# Deep-Trade-Q: TD3 модель для трейдинга

## Архитектура нейросети

TD3 (Twin Delayed Deep Deterministic Policy Gradient) модель использует следующую архитектуру:

- **Actor (Политика)**: 2 скрытых слоя по 64 нейрона каждый
- **Critic (Ценность)**: 2 скрытых слоя по 64 нейрона каждый

Эта архитектура определена в файле `config.py` и может быть легко изменена.

## Конфигурация

Все параметры модели и окружения вынесены в файл `config.py`:

### Параметры TD3 модели:
- `timesteps`: Общее количество шагов обучения (10000 по умолчанию)
- `learning_rate`: Скорость обучения (3e-4 = 0.0003)
- `batch_size`: Размер батча для обучения (256)
- `buffer_size`: Размер буфера опыта (100000)
- `noise_sigma`: Параметр шума для исследования
  - 0.1 - холодный (мало исследования)
  - 0.3 - теплый (среднее исследование)
  - 0.5 - горячий (много исследования)
- `net_arch`: Архитектура нейронной сети (слои и нейроны)
- `train_freq`: Частота обучения
- `eval_freq`: Частота оценки (каждые N шагов)
- `n_eval_episodes`: Количество эпизодов для оценки

### Параметры окружения:
- `window_size`: Размер окна для наблюдения (количество дней для анализа)
- `commission`: Комиссия за сделку (доля от суммы сделки)
- `max_inventory`: Максимальное количество позиций, которые можно держать одновременно
- `carry_cost`: Стоимость удержания позиции (штраф за каждый шаг удержания)
- `min_trade_value`: Минимальная стоимость сделки в долларах
- `risk_lambda`: Параметр риск-аверсии (вес риска в функции награды)
- `drawdown_lambda`: Вес просадки в функции награды
- `dual_phase`: Режим обучения (чередование фаз исследования и эксплуатации)

## Логирование и метрики

Модель логирует следующие метрики:
- Прибыль на тренировочных и валидационных данных
- Коэффициент Шарпа (Sharpe Ratio)
- Количество покупок, продаж и удержаний
- Детальная информация о каждой сделке (цена покупки, цена продажи, прибыль)

## Визуализация

Визуализация сделок на графике цен реализована через `VisualizeCallback`. Графики сохраняются в директории `plots/train` и `plots/val`.

## Проблемы и решения

1. **Проблема с коэффициентом Шарпа**: Добавлены проверки на аномальные значения и более подробные логи для отладки.
2. **Проблема с ценами**: Модель обучается на исторических данных с 2010 года, когда цены GOOG были около $12, и валидируется на данных 2024 года, когда цены около $180.
3. **Проблема с количеством шагов в эпизоде**: Добавлен параметр `max_steps` в класс `TradingEnv`, чтобы один эпизод соответствовал одному проходу по всем данным.

## Запуск обучения

```bash
python train.py data/GOOG_2010-2024-06.csv --strategy=td3 --window-size=50 --td3-timesteps=10000 --td3-noise-sigma=0.3 --td3-save-name=td3_trading_fixed --debug
```

## Запуск тестирования

```bash
python run_td3.py --stock=data/GOOG_2010-2024-06.csv --window-size=50
```
