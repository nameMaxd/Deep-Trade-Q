
чем чревато или хорошо Убирать per-step fit и вызывать replay лишь раз в N шагов или в конце эпизода ?

Плюсы удаления per-step fit и перехода к реплею раз в N шагов или в конце эпизода:

• Скорость
– Меньше вызовов model.fit → до N× быстрее (особенно на тяжёлых LSTM).
– Лучшее использование батчей: обновления «крупнее», меньше оверхеда Keras.

• Стабильность градиента
– Крупные батчи дают более гладкие градиенты и могут уменьшить шум в обучении.
– Меньше «дрожания» параметров от каждого шага среды.

• Гибкость
– Можно подобрать N (например, 5–10) под ваш бюджет времени/качества.

Минусы:

• Медленная реакция на новые данные
– Сигналы о прибыли/убытке будут доходить до сети с задержкой до N шагов.
– Потенциально более медленное распространение важного надачного пути (credit assignment).

• Более высокая корреляция в батче
– Если реплей делается редко, один батч может содержать соседние по времени состояния → ухудшает randomization.

• Возможный «переполив» памяти
– При большом эпизоде и одной финальной реплизации ранние кадры могут выпасть из память-буфера до первого обновления.

Рекомендация: задать разумный интервал (например, replay_freq=10–20) или частично по шагам, частично в конце эпизода, чтобы сохранить баланс скорости и sample-efficiency.